{
  "version": "2.0.0",
  "generated_at": "2025-01-07T18:00:00Z",
  "description": "Storage wiring map - all components now standardized with helpers",
  "status": "✅ COMPLETE",
  "components": [
    {
      "file": "src/components/DocumentManager.tsx",
      "status": "✅ COMPLETE",
      "table": "public.documents",
      "columns": ["project_id", "nombre", "file_url", "tipo_carpeta", "etiqueta", "visibilidad", "file_size", "file_type", "uploaded_by"],
      "bucket": "documentos (interno) | project_docs (cliente)",
      "path_pattern": "projectId/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket", "getSignedUrl", "deleteFromBucket"],
      "notes": "✅ Bucket selection based on visibilidad, stores relative paths, uses signed URLs"
    },
    {
      "file": "src/hooks/useProjectDocuments.ts",
      "status": "✅ COMPLETE",
      "table": "public.documents",
      "columns": ["project_id", "nombre", "file_url", "tipo_carpeta", "visibilidad", "file_size", "file_type", "uploaded_by"],
      "bucket": "project_docs",
      "path_pattern": "projectId/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket", "getSignedUrl", "deleteFromBucket"],
      "notes": "✅ Standard implementation for ERP document management"
    },
    {
      "file": "src/hooks/useClientDocumentsUpload.ts",
      "status": "✅ COMPLETE",
      "table": "public.documents",
      "columns": ["project_id", "nombre", "file_url", "tipo_carpeta", "etiqueta", "visibilidad", "file_size", "file_type", "uploaded_by"],
      "bucket": "project_docs",
      "path_pattern": "projectId/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket", "deleteFromBucket"],
      "notes": "✅ Client-facing document upload with standard helpers"
    },
    {
      "file": "src/components/construction/ConstructionPhotosTab.tsx",
      "status": "✅ COMPLETE",
      "table": "public.construction_photos",
      "columns": ["project_id", "file_url", "file_name", "latitude", "longitude", "fecha_foto", "descripcion", "visibilidad", "uploaded_by"],
      "bucket": "construction-photos",
      "path_pattern": "projectId/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket", "getSignedUrl", "deleteFromBucket"],
      "notes": "✅ Construction photos with signed URLs and standard paths"
    },
    {
      "file": "src/hooks/useDesignDeliverables.ts",
      "status": "✅ COMPLETE",
      "table": "public.design_deliverables",
      "columns": ["project_id", "phase_id", "file_name", "file_url", "file_type", "file_size", "description", "uploaded_by"],
      "bucket": "design-deliverables",
      "path_pattern": "projectId/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket", "getSignedUrl", "deleteFromBucket"],
      "notes": "✅ Design deliverables with cleanup on DB insert failure"
    },
    {
      "file": "src/components/BudgetItemDialog.tsx",
      "status": "✅ COMPLETE",
      "table": "public.budget_attachments",
      "columns": ["budget_item_id", "file_name", "file_url", "file_type", "file_size"],
      "bucket": "documentos",
      "path_pattern": "budget_item_id/YYMM-uuid-filename.ext",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket"],
      "notes": "✅ Uses budget_item_id as projectId for path organization"
    },
    {
      "file": "src/components/accounting/CfdiUploadDialog.tsx",
      "status": "✅ COMPLETE",
      "table": "public.invoices",
      "columns": ["tipo", "metodo_pago", "issued_at", "uuid", "folio", "total_amount", "emisor_id", "receptor_id", "xml_url", "meta_json"],
      "bucket": "cfdi",
      "path_pattern": "emisor_rfc/YYMM-uuid-{uuid}.xml",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket"],
      "notes": "✅ Uses emisor RFC as projectId, stores path in xml_url"
    },
    {
      "file": "src/components/WishlistForm.tsx",
      "status": "✅ COMPLETE",
      "table": "public.wishlists",
      "columns": ["project_id", "payload", "firma_tipo", "firma_url", "firmado", "firmado_at"],
      "bucket": "firmas",
      "path_pattern": "projectId/YYMM-uuid-firma.{ext}",
      "read_mode": "signed",
      "helpers_used": ["uploadToBucket"],
      "notes": "✅ Handles both canvas signatures (PNG) and PDF uploads"
    }
  ],
  "client_app_views": [
    {
      "file": "src/hooks/useClientDocuments.ts",
      "status": "✅ COMPLETE",
      "view": "public.v_client_documents",
      "bucket": "project_docs",
      "read_mode": "signed",
      "notes": "✅ Read-only view for client-visible documents, uses getSignedUrl for downloads"
    },
    {
      "file": "src/hooks/useClientPhotos.ts",
      "status": "✅ COMPLETE",
      "view": "public.v_client_photos",
      "bucket": "construction-photos",
      "read_mode": "signed",
      "notes": "✅ Read-only view for client-visible photos, uses getSignedUrl for viewing"
    },
    {
      "file": "src/features/client/hooks/useClientDocuments.ts",
      "status": "✅ COMPLETE",
      "table": "public.documents",
      "bucket": "project_docs",
      "read_mode": "signed",
      "notes": "✅ Alternative client documents hook, queries documents table directly with filters"
    }
  ],
  "storage_helpers": {
    "file": "src/lib/storage/storage-helpers.ts",
    "status": "✅ COMPLETE",
    "functions": [
      {
        "name": "buildPath",
        "description": "Generates standardized path: projectId/YYMM-uuid-slugified-filename.ext",
        "params": ["projectId", "filename"],
        "returns": "string"
      },
      {
        "name": "uploadToBucket",
        "description": "Uploads file to bucket with standard path, returns { path }",
        "params": ["bucket", "projectId", "file", "filename?"],
        "returns": "Promise<{ path: string }>"
      },
      {
        "name": "getSignedUrl",
        "description": "Generates temporary signed URL (default 600s)",
        "params": ["bucket", "path", "expiresInSeconds?"],
        "returns": "Promise<{ url: string }>"
      },
      {
        "name": "deleteFromBucket",
        "description": "Deletes file from bucket",
        "params": ["bucket", "path"],
        "returns": "Promise<boolean>"
      }
    ],
    "notes": "Central storage helper used across all upload/read/delete flows"
  },
  "buckets": {
    "file": "src/lib/storage/buckets.ts",
    "status": "✅ COMPLETE",
    "buckets": [
      {
        "name": "documentos",
        "private": true,
        "usage": "Internal documents and budget attachments"
      },
      {
        "name": "project_docs",
        "private": true,
        "usage": "Client-visible documents"
      },
      {
        "name": "design-deliverables",
        "private": true,
        "usage": "Design phase deliverables"
      },
      {
        "name": "construction-photos",
        "private": true,
        "usage": "Construction progress photos"
      },
      {
        "name": "cfdi",
        "private": true,
        "usage": "CFDI XML invoices"
      },
      {
        "name": "firmas",
        "private": true,
        "usage": "Digital signatures (canvas and PDF)"
      }
    ]
  },
  "conventions": {
    "path_format": "projectId/YYMM-uuid-slugified-filename.ext",
    "storage_column": "file_url (stores relative path only)",
    "read_method": "createSignedUrl() with 600s default expiry",
    "upload_method": "uploadToBucket() helper",
    "delete_method": "deleteFromBucket() helper",
    "security": "All buckets private, no service keys in frontend"
  },
  "summary": {
    "total_components": 8,
    "total_views": 3,
    "all_standardized": true,
    "using_helpers": true,
    "storing_relative_paths": true,
    "using_signed_urls": true,
    "path_convention_applied": true,
    "status": "✅ ALL COMPONENTS COMPLETE"
  }
}
