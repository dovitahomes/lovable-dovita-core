{
  "unified_storage": {
    "description": "Mapa de auditoría del sistema de storage unificado. Todas las rutas son relativas (sin bucket/dominio). Lectura usa signed URLs para buckets privados.",
    "updated_at": "2025-01-08",
    "storage_helpers": "src/lib/storage/storage-helpers.ts",
    "buckets": "src/lib/storage/buckets.ts"
  },
  "mappings": {
    "construction_photos.file_url": {
      "bucket": "project_photos",
      "private": true,
      "path_format": "{project_id}/{YYMM}-{uuid}-{filename}",
      "hooks": [
        "src/hooks/useConstructionPhotosUpload.ts",
        "src/hooks/useProjectPhotos.ts",
        "src/hooks/useClientPhotos.ts"
      ],
      "components": [
        "src/components/construction/ConstructionPhotosTab.tsx"
      ],
      "views": ["v_client_photos"],
      "status": "✅ Implementado - rutas relativas + signed URLs"
    },
    "documents.file_url": {
      "bucket": "project_docs",
      "private": true,
      "path_format": "{project_id}/{YYMM}-{uuid}-{filename}",
      "hooks": [
        "src/hooks/useDocumentsUpload.ts",
        "src/hooks/useUnifiedProjectDocuments.ts",
        "src/features/client/hooks/useClientDocuments.ts"
      ],
      "components": [
        "src/components/project/ProjectDocumentsTab.tsx"
      ],
      "views": ["v_client_documents"],
      "status": "✅ Implementado - rutas relativas + signed URLs"
    },
    "crm_attachments.file_url": {
      "bucket": "crm-attachments",
      "private": true,
      "path_format": "{entity_id}/{YYMM}-{uuid}-{filename}",
      "hooks": [
        "src/hooks/crm/useCrmAttachments.ts"
      ],
      "components": [
        "src/components/crm/AttachmentsTab.tsx"
      ],
      "status": "✅ Implementado - rutas relativas + signed URLs"
    },
    "budget_attachments.file_url": {
      "bucket": "documentos",
      "private": true,
      "path_format": "{budget_item_id}/{YYMM}-{uuid}-{filename}",
      "components": [
        "src/components/BudgetItemDialog.tsx"
      ],
      "status": "✅ Implementado - rutas relativas (bucket documentos compartido)"
    },
    "invoices.xml_path": {
      "bucket": "cfdi",
      "private": true,
      "path_format": "{emisor_rfc}/{YYYY-MM}-{uuid}-{filename}.xml",
      "notes": "Usa buildCfdiPath() con formato específico YYYY-MM",
      "status": "⚠️ Pendiente - requiere hook useUploadCfdi + extract_cfdi_metadata RPC"
    },
    "invoices.pdf_path": {
      "bucket": "cfdi",
      "private": true,
      "path_format": "{emisor_rfc}/{YYYY-MM}-{uuid}-{filename}.pdf",
      "status": "⚠️ Pendiente - misma implementación que xml_path"
    },
    "wishlists.firma_url": {
      "bucket": "firmas",
      "private": true,
      "path_format": "{project_id}/{YYMM}-{uuid}-firma.png",
      "components": [
        "src/components/WishlistForm.tsx"
      ],
      "status": "✅ Implementado - rutas relativas"
    },
    "profiles.avatar_url": {
      "bucket": "avatars",
      "private": false,
      "path_format": "{user_id}/{YYMM}-{uuid}-{filename}",
      "hooks": [
        "src/hooks/useUploadAvatar.ts"
      ],
      "status": "✅ Implementado - bucket público, guarda ruta relativa"
    }
  },
  "pending_migrations": [
    {
      "module": "Finanzas/CFDI",
      "actions": [
        "Crear hook useUploadCfdi con validación XML",
        "Implementar llamada a extract_cfdi_metadata(xml_text) RPC",
        "Actualizar CfdiUploadDialog para usar nuevo hook",
        "Agregar signed URL display para XMLs/PDFs existentes"
      ],
      "priority": "media"
    }
  ],
  "normalization_rules": {
    "path_storage": "Siempre guardar SOLO ruta relativa en DB (sin bucket, sin dominio)",
    "url_generation": "Usar getSignedUrl(bucket, path, ttl) para buckets privados",
    "public_buckets": "Solo 'avatars' es público; usar getPublicUrl solo para este",
    "filename_slugify": "Normalizar con buildPath: lowercase, sin acentos, _ para espacios",
    "cleanup_on_error": "Si falla INSERT en DB, eliminar archivo de storage (deleteFromBucket)"
  },
  "helper_functions": {
    "uploadToBucket": "Upload file y retorna { path }",
    "getSignedUrl": "Genera URL firmada con TTL (default 600s para private buckets)",
    "deleteFromBucket": "Elimina archivo de storage",
    "buildPath": "Construye ruta normalizada {projectId}/{YYMM}-{uuid}-{slugified}",
    "buildCfdiPath": "Construye ruta CFDI {rfc}/{YYYY-MM}-{uuid}-{filename}",
    "extractFileMetadata": "Extrae metadata de File object (size, type, etc.)"
  },
  "client_app_integration": {
    "data_source": "Siempre consume vistas v_client_* (filtradas por visibilidad='cliente')",
    "signed_urls": "Todos los archivos mostrados usan signed URLs con TTL 3600s",
    "no_writes": "Client App es read-only; no puede subir/eliminar archivos",
    "mock_toggle": "PreviewBar permite alternar mock/real data (default: real)"
  }
}
